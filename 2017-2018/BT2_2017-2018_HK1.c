#INCLUDE<16F887.H>
#DEVICE ADC=10
#FUSES HS
#USE DELAY(CLOCK=11.0592M)

#USE RS232(BAUD=9600,BITS=8,STOP=1,PARITY=N, XMIT=PIN_C6,RCV=PIN_C7)

#DEFINE LD1 PIN_C1
#DEFINE LD2 PIN_C2

CONST UNSIGNED INT8 MA7DOAN[10] = {0XC0, 0XF9, 0XA4, 0XB0, 0X99, 0X92, 0X82, 0XF8, 0X80, 0X90};
UNSIGNED INT16 I;
UNSIGNED INT16 TEMP1=0,TEMP2=0,OLDTEMP1=0,OLDTEMP2=0;
CHAR RXDATA='1';


VOID READ_AN5()
{
   //READ TEMPERATURE ADC1
   SET_ADC_CHANNEL(5);
   DELAY_US(10);
   //READ AVR 300 TIMES
   TEMP1=0; //GAN LAI NHIET DO BANG 0 VOI NHUNG BAI DO NHIEU LAN
   FOR(I=0;I<300;I++)
   {
      TEMP1=TEMP1+READ_ADC();
   }
   TEMP1=TEMP1/300/2.046;
   OUTPUT_D(MA7DOAN[TEMP1/10]);
   OUTPUT_B(MA7DOAN[TEMP1%10]);
}

VOID READ_AN6()
{
   //READ TEMPERATURE ADC2
   SET_ADC_CHANNEL(6);
   DELAY_US(20);
   //READ AVR 300 TIMES
   TEMP2=0; //GAN LAI NHIET DO BANG 0 VOI NHUNG BAI DO NHIEU LAN
   FOR(I=0;I<300;I++)
   {
      TEMP2=TEMP2+READ_ADC();
   }
   TEMP2=TEMP2/300/2.046;
   OUTPUT_D(MA7DOAN[TEMP2/10]);
   OUTPUT_B(MA7DOAN[TEMP2%10]);
}

VOID MAIN()
{
   SET_TRIS_C(0B10000000);
   SET_TRIS_D(0X00);
   SET_TRIS_B(0X00);
   SET_TRIS_E(0B00000011);
   //SETUP ADC
   SETUP_ADC(ADC_CLOCK_INTERNAL);
   SETUP_ADC_PORTS(SAN5|SAN6|VSS_VDD);
   
   WHILE(TRUE)
   {
      IF(KBHIT()==1)
      {
         RXDATA=GETC();
      }
      IF(RXDATA=='1')
      {
         READ_AN5();
         OUTPUT_HIGH(LD1);
         OUTPUT_LOW(LD2);
         IF(OLDTEMP1!=TEMP1)
         {
            OLDTEMP1=TEMP1;
            PRINTF("TEMP1=%02LU",TEMP1);
         }
      }
      ELSE IF(RXDATA=='2')
      {
         READ_AN6();
         OUTPUT_HIGH(LD2);
         OUTPUT_LOW(LD1);
         IF(OLDTEMP2!=TEMP2)
         {
            OLDTEMP2=TEMP2;
            PRINTF("TEMP2=%02LU",TEMP2);
         }
      }
      ELSE IF(RXDATA=='3')
      {
         READ_AN5();
         OUTPUT_HIGH(LD1);
         OUTPUT_LOW(LD2);
         DELAY_MS(3000);
         READ_AN6();
         OUTPUT_HIGH(LD2);
         OUTPUT_LOW(LD1);
         DELAY_MS(3000);
      }  
   }
}
